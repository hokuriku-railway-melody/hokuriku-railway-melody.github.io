<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="北陸地区の駅メロディーをまとめたページです。">
  <meta name="robots" content="index, follow">

  <meta property="og:title" content="ほくりく駅メロ図鑑">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="ほくりく駅メロ図鑑">
  <meta property="og:locale" content="ja_JP">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ほくりく駅メロ図鑑">
  <meta name="twitter:description" content="北陸地区の駅メロディーをまとめたページです。">

  <title>ほくりく駅メロ図鑑</title>
  <link rel="stylesheet" href="https://hokuriku-railway-melody.github.io/style.css"/>
  <link rel="icon" href="" id="favicon">
</head>
<body>
  <header>
    <h1><a href="https://hokuriku-railway-melody.github.io/" style="color: white;"><img id="station-image" src="" alt="鉄道車両画像"/> ほくりく駅メロ図鑑</a></h1>
  </header>

  <div class="container">
    <aside id="menu"></aside>

    <main id="content">
      <section>
        <h2 id="station-heading"></h2>
        <div id="station-nav"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>乗換路線</h2>
        <div id="line-links"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>乗換駅</h2>
        <div id="transfer-links"></div>
      </section>
      <div class="spacer"></div>
      <section>
        <h2>駅メロディー</h2>
        <table>
          <thead>
            <tr>
              <th>ホーム</th>
              <th>発着</th>
              <td>曲</td>
              <td>音声</td>
              <td>備考</td>
            </tr>
          </thead>
          <tbody id="station-table-body"></tbody>
        </table>
      </section>
    </main>
  </div>

  <footer>
    <p>Copyright © いゆかも工房 All rights reserved.</p>
  </footer>

  <script>
    const params = new URLSearchParams(location.search);
    const com = params.get("com");
    const sta = params.get("sta");
  
    fetch("https://hokuriku-railway-melody.github.io/station.json")
      .then(res => res.json())
      .then(data => {
        function formatTime(seconds) {
          if (isNaN(seconds)) return "0:00";
          const min = Math.floor(seconds / 60);
          const sec = Math.floor(seconds % 60);
          return `${min}:${sec.toString().padStart(2, "0")}`;
        }
        
        let match = data.find(item => item.com === com && item.sta === sta);
  
        if (!match) {
          match = {
            natcom: "存在しないページ：",
            natsta: "Error 404 Not Found",
            up: "none",
            upurl: "none",
            down: "none",
            downurl: "none",
            line: "この駅のページは存在しません。",
            lineurl: "none",
            color: "#000000",
            platform: "0番のりば",
            ad: "エラー",
            sound: "エラー",
            melody: "none",
            note: "正しいURLを入力するか、更新を待ってください。",
            image: "https://hokuriku-railway-melody.github.io/image/413.png",
            numshape: "circle",
            numcolor: "#000000",
            numpaint: "edge",
            numcolorarea: "top",
            numsign: "Error",
            numnum: "404",
            numsigncolor: "#ffffff",
            numnumcolor: "#000000"
          };
        }
  
        document.title = `ほくりく駅メロ図鑑 | ${match.natsta}`;
        document.getElementById("favicon").href = match.image;
        document.getElementById("station-image").src = match.image;
  
        const heading = document.getElementById("station-heading");
  
        let colorSpan = "";
        if (match.color && match.color !== "none") {
          const colors = match.color.split(",");
          const segmentHeight = 100 / colors.length;
          const segments = colors.map((c, i) => `${c} ${i * segmentHeight}%, ${c} ${(i + 1) * segmentHeight}%`).join(", ");
          colorSpan = `<span class="line-color" style="background: linear-gradient(to bottom, ${segments});"></span>`;
        }
  
        heading.innerHTML = `${colorSpan}${match.natcom} ${match.natsta}`;
  
        const sign = match.numsign !== "none" ? match.numsign : "";
        const num = match.numnum !== "none" ? match.numnum : "";
  
        if (
          match.numshape !== "none" &&
          match.numcolor !== "none" &&
          match.numpaint !== "none" &&
          (sign || num)
        ) {
          const shape = match.numshape;
          const color = match.numcolor;
          const paint = match.numpaint;
          const signColor = match.numsigncolor || match.numtextcolor || "#000";
          const numColor = match.numnumcolor || match.numtextcolor || "#000";
          const colorArea = match.numcolorarea || "none";
  
          const badge = document.createElement("span");
          badge.style.width = "48px";
          badge.style.height = "48px";
          badge.style.display = "inline-block";
          badge.style.position = "relative";
          badge.style.fontWeight = "bold";
          badge.style.marginLeft = "0.5em";
          badge.style.border = `2px solid ${color}`;
          badge.style.verticalAlign = "middle";
          badge.style.textAlign = "center";
          if (shape === "circle") badge.style.borderRadius = "50%";
  
          if (paint === "fill") {
            badge.style.backgroundColor = color;
          } else if (paint === "edge" && colorArea !== "none") {
            badge.style.background = colorArea === "top"
              ? `linear-gradient(to bottom, ${color} 50%, #fff 50%)`
              : `linear-gradient(to bottom, #fff 50%, ${color} 50%)`;
          } else {
            badge.style.backgroundColor = "#fff";
          }
  
          const inner = document.createElement("div");
          inner.style.position = "absolute";
          inner.style.top = "0";
          inner.style.left = "0";
          inner.style.width = "100%";
          inner.style.height = "100%";
          inner.style.display = "flex";
          inner.style.flexDirection = "column";
          inner.style.justifyContent = "center";
          inner.style.alignItems = "center";
  
          if (sign && num) {
            inner.style.fontSize = "20px";
            inner.innerHTML = `<div style="color:${signColor}">${sign}</div><div style="color:${numColor}">${num}</div>`;
          } else {
            inner.style.fontSize = "40px";
            inner.innerHTML = `<div style="color:${sign ? signColor : numColor}">${sign || num}</div>`;
          }
  
          badge.appendChild(inner);
          heading.appendChild(badge);
        }
  
        const upNames = (match.up?.split(",") || []).filter(name => name !== "none");
        const downNames = (match.down?.split(",") || []).filter(name => name !== "none");
        const upUrls = (match.upurl?.split(",") || []).filter(url => url !== "none");
        const downUrls = (match.downurl?.split(",") || []).filter(url => url !== "none");
  
        const upLinks = upNames.map((name, i) => {
          const url = upUrls[i];
          return url
            ? `<a href="${url}" class="contact-button">${name}</a>`
            : `<span class="contact-button">${name}</span>`;
        }).join("・");
  
        const downLinks = downNames.map((name, i) => {
          const url = downUrls[i];
          return url
            ? `<a href="${url}" class="contact-button">${name}</a>`
            : `<span class="contact-button">${name}</span>`;
        }).join("・");
  
        const navHTML = `
          <div style="margin: 1em 0;">
            ${upLinks ? `<span style="margin-right:1em;">←${upLinks}</span>` : ""}
            ${downLinks ? `<span style="margin-left:1em;">${downLinks}→</span>` : ""}
          </div>
        `;
        document.getElementById("station-nav").innerHTML = navHTML;
  
        const lines = match.line.split(",");
        const urls = match.lineurl.split(",");
        const lineHTML = lines.map((line, i) => {
          const url = urls[i];
          return url !== "none"
            ? `<a href="${url}" class="contact-button">${line}</a>`
            : `<span class="contact-button">${line}</span>`;
        }).join("<br>");
        document.getElementById("line-links").innerHTML = lineHTML;

        const transfers = match.transfer?.split(",") || [];
        const transferUrls = match.transferurl?.split(",") || [];
        
        const transferHTML = transfers
          .map((name, i) => {
            const url = transferUrls[i];
            if (!name || name === "none" || !url || url === "none") return null;
            return `<a href="${url}" class="contact-button">${name}</a>`;
          })
          .filter(Boolean)
          .join("<br>");
        
        if (transferHTML) {
          document.getElementById("transfer-links").innerHTML = transferHTML;
        }
        
        const platforms = match.platform.split(",");
        const ads = match.ad.split(",");
        const sounds = match.sound.split(",");
        const melodies = match.melody.split(",");
        const notes = match.note.split(",");
  
        const tbody = document.getElementById("station-table-body");
        tbody.innerHTML = "";
  
        for (let i = 0; i < platforms.length; i++) {
          const tr = document.createElement("tr");
  
          const th1 = document.createElement("th");
          th1.textContent = platforms[i];
          tr.appendChild(th1);
  
          const th2 = document.createElement("th");
          th2.textContent = ads[i];
          tr.appendChild(th2);
  
          const td1 = document.createElement("td");
          td1.textContent = sounds[i];
          tr.appendChild(td1);
  
          const td2 = document.createElement("td");
          
          if (melodies[i] !== "none") {
            const audio = document.createElement("audio");
            audio.src = melodies[i];
            audio.preload = "metadata";
            audio.style.display = "none";
          
            const playLink = document.createElement("a");
            playLink.textContent = "▶";
            playLink.id = "contact-button-square";
            playLink.style.cursor = "pointer";
          
            const stopLink = document.createElement("a");
            stopLink.textContent = "■";
            stopLink.id = "contact-button-square";
            stopLink.style.cursor = "pointer";
            stopLink.style.marginLeft = "0.5em";
          
            const timeDisplay = document.createElement("span");
            timeDisplay.textContent = "0:00/0:00";
            timeDisplay.style.marginLeft = "0.5em";
          
            playLink.onclick = () => {
              audio.play();
            };
          
            stopLink.onclick = () => {
              audio.pause();
              audio.currentTime = 0;
              updateTimeDisplay();
            };
          
            function updateTimeDisplay() {
              const current = formatTime(audio.currentTime);
              const total = formatTime(audio.duration || 0);
              timeDisplay.textContent = `${current}/${total}`;
            }
          
            audio.addEventListener("timeupdate", updateTimeDisplay);
          
            audio.addEventListener("loadedmetadata", updateTimeDisplay);
          
            td2.appendChild(playLink);
            td2.appendChild(stopLink);
            td2.appendChild(timeDisplay);
            td2.appendChild(audio);
          } else {
            td2.textContent = "なし";
          }
          tr.appendChild(td2);
  
          const td3 = document.createElement("td");
          td3.textContent = (!notes[i] || notes[i] === "none") ? "なし" : notes[i];
          tr.appendChild(td3);
  
          tbody.appendChild(tr);
        }
      });
  
    fetch("https://hokuriku-railway-melody.github.io/menu.json")
      .then(res => res.json())
      .then(data => {
        const menu = document.getElementById("menu");
        const ul = document.createElement("ul");
        data.forEach(item => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = item.link;
          a.textContent = item.title;
          li.appendChild(a);
          ul.appendChild(li);
        });
        menu.appendChild(ul);
      });
  </script>
</body>
</html>
